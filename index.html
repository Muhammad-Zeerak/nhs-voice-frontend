<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHS Connect | AI Receptionist</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #005EB8; /* NHS Blue */
            --primary-dark: #003087;
            --accent: #00A9CE; /* Bright Cyan */
            --bg-grad-start: #f0f7fa;
            --bg-grad-end: #e1e9f0;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --error: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* --- Main Card Container --- */
        .app-container {
            background: var(--surface);
            width: 100%;
            max-width: 420px;
            border-radius: 24px;
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.1), 
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        /* NHS Logo / Badge */
        .badge {
            background-color: var(--primary);
            color: white;
            padding: 6px 16px;
            font-weight: 700;
            font-size: 14px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 20px;
            letter-spacing: 0.5px;
        }

        h1 {
            color: var(--text-main);
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 10px 0;
        }

        p.subtitle {
            color: var(--text-sub);
            font-size: 15px;
            margin-bottom: 40px;
            line-height: 1.5;
        }

        /* --- Microphone Button Area --- */
        .mic-wrapper {
            position: relative;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        /* The Pulse Animation Rings */
        .pulse-ring {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary);
            opacity: 0;
            transform: scale(0.8);
        }

        /* Active State Animation */
        .mic-wrapper.active .pulse-ring {
            animation: pulse-animation 2s infinite;
        }
        .mic-wrapper.active .pulse-ring:nth-child(2) {
            animation-delay: 0.5s;
        }

        @keyframes pulse-animation {
            0% { transform: scale(0.8); opacity: 0.4; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        /* The Button Itself */
        #mic-btn {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 10px 20px rgba(0, 94, 184, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        #mic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 94, 184, 0.4);
        }

        #mic-btn:active {
            transform: scale(0.95);
        }

        #mic-btn svg {
            width: 40px;
            height: 40px;
            fill: white;
            transition: transform 0.3s ease;
        }

        /* --- Status & Response --- */
        #status-text {
            font-weight: 600;
            color: var(--primary);
            min-height: 24px;
            margin-bottom: 20px;
            font-size: 16px;
            transition: color 0.3s ease;
        }

        .chat-bubble {
            background: #F3F4F6;
            color: var(--text-main);
            padding: 20px;
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            text-align: left;
            font-size: 15px;
            line-height: 1.6;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease;
            display: none;
            position: relative;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Little triangle for chat bubble */
        .chat-bubble::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -8px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right-color: #F3F4F6;
            border-bottom: 0;
            margin-bottom: 0;
        }

        .chat-bubble.visible {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        /* --- States --- */
        .is-recording #mic-btn {
            background: #ef4444;
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
        }
        .is-processing #status-text {
            color: var(--text-sub);
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 480px) {
            .app-container {
                height: 100vh;
                border-radius: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="badge">NHS Connect</div>

        <h1>Virtual Receptionist</h1>
        <p class="subtitle">Press and hold the button to speak.</p>

        <div id="status-text">Ready to help</div>

        <div class="mic-wrapper" id="mic-wrapper">
            <div class="pulse-ring"></div>
            <div class="pulse-ring"></div>
            
            <button id="mic-btn" 
                onmousedown="startRecording()" 
                onmouseup="stopRecording()" 
                ontouchstart="startRecording()" 
                ontouchend="stopRecording()">
                
                <svg viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 2.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            </button>
        </div>

        <div id="response-box" class="chat-bubble"></div>
    </div>

    <script>
        // ==========================================
        //  CONFIG: PASTE YOUR N8N WEBHOOK URL HERE
        // ==========================================
        const WEBHOOK_URL = "https://i-zeerak.app.n8n.cloud/webhook-test/voice-chat"; 
        // IMPORTANT: Replace with your actual n8n webhook URL
        // ==========================================

        let mediaRecorder;
        let audioChunks = [];
        const statusEl = document.getElementById('status-text');
        const micWrapper = document.getElementById('mic-wrapper');
        const responseBox = document.getElementById('response-box');
        
        // Session ID Handling - maintains conversation continuity
        let sessionId = localStorage.getItem('nhs_session_id');
        if (!sessionId) {
            sessionId = 'session_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('nhs_session_id', sessionId);
        }
        
        console.log('Session ID:', sessionId);

        // --- Recording Functions ---

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = sendAudio;
                
                mediaRecorder.start();

                // UI Updates
                micWrapper.classList.add('active');
                document.body.classList.add('is-recording');
                statusEl.innerText = "Listening...";
                statusEl.style.color = "#ef4444";
                
                // Hide previous response
                responseBox.classList.remove('visible');

            } catch (err) {
                console.error("Microphone Error:", err);
                statusEl.innerText = "Microphone access required";
                statusEl.style.color = "var(--error)";
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                
                // Stop all audio tracks
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                // UI Updates
                micWrapper.classList.remove('active');
                document.body.classList.remove('is-recording');
                document.body.classList.add('is-processing');
                
                statusEl.innerText = "Processing...";
                statusEl.style.color = "var(--text-sub)";
            }
        }

        // --- Networking & AI ---

        async function sendAudio() {
            if (audioChunks.length === 0) {
                console.error('No audio data recorded');
                document.body.classList.remove('is-processing');
                statusEl.innerText = "No audio detected. Try again.";
                statusEl.style.color = "var(--error)";
                return;
            }

            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            console.log('Audio blob size:', audioBlob.size, 'bytes');
            
            const formData = new FormData();
            formData.append('data', audioBlob, 'voice.webm');
            formData.append('sessionId', sessionId);

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }

                const json = await response.json();
                console.log('Response data:', json);
                handleResponse(json);

            } catch (err) {
                console.error('Network error:', err);
                document.body.classList.remove('is-processing');
                statusEl.innerText = "Connection Error";
                statusEl.style.color = "var(--error)";
                
                // Fallback response
                responseBox.innerText = "Sorry, I'm having trouble connecting. Please try again.";
                responseBox.classList.add('visible');
            }
        }

        function handleResponse(data) {
            document.body.classList.remove('is-processing');
            statusEl.innerText = "Sarah says:";
            statusEl.style.color = "var(--primary)";

            // Handle different response structures from n8n
            let responseText = "";
            
            // Try different possible response structures
            if (data.voice_response) {
                responseText = data.voice_response;
            } else if (data.output && data.output.voice_response) {
                responseText = data.output.voice_response;
            } else if (data.json && data.json.voice_response) {
                responseText = data.json.voice_response;
            } else if (typeof data === 'string') {
                try {
                    const parsed = JSON.parse(data);
                    responseText = parsed.voice_response || parsed.output?.voice_response || "I didn't catch that.";
                } catch {
                    responseText = data;
                }
            } else {
                console.warn('Unexpected response format:', data);
                responseText = "Sorry, I didn't catch that. Could you please repeat?";
            }

            console.log('Final response text:', responseText);

            // Show Chat Bubble
            responseBox.innerText = responseText;
            responseBox.classList.add('visible');

            // Speak Audio
            speak(responseText);
            
            // Reset status after speaking
            setTimeout(() => {
                statusEl.innerText = "Ready to help";
                statusEl.style.color = "var(--primary)";
            }, 3000);
        }

        function speak(text) {
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Wait for voices to load
            const setVoice = () => {
                const voices = window.speechSynthesis.getVoices();
                // Prefer British English voice
                const britishVoice = voices.find(v => 
                    v.lang.includes('en-GB') || 
                    v.name.includes('UK') || 
                    v.name.includes('British')
                );
                
                if (britishVoice) {
                    utterance.voice = britishVoice;
                }
            };
            
            // Voices might not be loaded yet
            if (window.speechSynthesis.getVoices().length > 0) {
                setVoice();
            } else {
                window.speechSynthesis.onvoiceschanged = setVoice;
            }
            
            utterance.rate = 0.95;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            window.speechSynthesis.speak(utterance);
        }
        
        // Reset conversation function (optional - for testing)
        function resetConversation() {
            localStorage.removeItem('nhs_session_id');
            sessionId = 'session_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('nhs_session_id', sessionId);
            console.log('New Session ID:', sessionId);
            responseBox.classList.remove('visible');
            statusEl.innerText = "Ready to help";
            statusEl.style.color = "var(--primary)";
        }
        
        // Double-tap badge to reset conversation (for testing)
        let tapCount = 0;
        document.querySelector('.badge').addEventListener('click', () => {
            tapCount++;
            if (tapCount === 2) {
                resetConversation();
                tapCount = 0;
            }
            setTimeout(() => tapCount = 0, 500);
        });
    </script>
</body>
</html>
